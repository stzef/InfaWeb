{% extends 'layouts/base.html' %}

{% load static %}

{% block content_head %}
	<link rel="stylesheet" href="{% static 'css/dataTables.bootstrap.css' %}">
	<link rel="stylesheet" href="https://cdn.rawgit.com/Eonasdan/bootstrap-datetimepicker/e8bddc60e73c1ec2475f827be36e1957af72e2ea/build/css/bootstrap-datetimepicker.css">
{% endblock content_head %}

{% block content %}
	{% include 'elements/nav.html' %}
	{% include 'elements/sidebar.html' %}
	<div class="content-wrapper" style="min-height: 921px;">
		<section class="content-header">
			<h1>Calculo de Costos y Existencias</h1>
		</section>
		<section class="content">
			<form class="form-horizontal" id="form_costing_and_stock">
				{{ form.as_p }}
				<div class="text-center">
					<div class="btn-group">
						<!--<button class="btn btn-app btn-info" type="submit">
							<i class="fa fa-plus-square-o"></i>Caulcular
						</button>-->
						<button class="btn btn-app" type="button" id="btn-save">
							<i class="fa fa-plus-square-o"></i>Guardar
						</button>
					</div>
				</div>
			</form>
			<div>
				<table id="costing_and_stock" class="table">
					<thead>
						<th>Cod Interno</th>
						<th>Nombre Articulo</th>
						<th>Cantidad</th>
						<th>Costo</th>
					</thead>
					<tbody></tbody>
				</table>
			</div>
		</section>
	</div>
	{% include 'elements/footer.html' %}
{% endblock %}

{% block content_script %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.js"></script>
<script src="https://cdn.rawgit.com/Eonasdan/bootstrap-datetimepicker/e8bddc60e73c1ec2475f827be36e1957af72e2ea/src/js/bootstrap-datetimepicker.js"></script>

<script>

	function llenar_planilla(response){
		console.log(response);
		$("#costing_and_stock tbody tr").remove();
		response.data.forEach(function(object){
			console.log(object.data);
			$("#costing_and_stock tbody").append(
				$("<tr>",
					{
						"data-change":object.change,
						"data-carlos":object.carlos,
						"data-canti":object.data.new_canti,
						"data-vcosto":object.data.current_vcosto
					}
				).append(
					$("<td>",{html:object.carlos}),
					$("<td>",{html:object.ncorto}),
					$("<td>",{html:object.data.new_canti}),
					$("<td>",{html:currencyFormat.format(object.data.new_vcosto)})
				)
			);
		});
		$("form").prepend(alertBootstrap("El proceso se completo exitosamente","success"))
	}
	$(document).ready(function() {
		if($('#id_nota_inicial').val() == ''){
			alert('Debe agregar una nota de inventario en parametros.');
			window.location.replace("{% url 'list-parameter' %}");
		}
	});
	$("#id_fecha_nota_inicial").datetimepicker({
		format: format_date_appen,
		defaultDate:date_appen
	});
	$("#id_fecha_final").datetimepicker({
		format: format_date_appen,
		defaultDate:new Date(new Date().setDate(new Date().getDate()+1))
	});
	$("#btn-save").click(function(event) {
		$.post(
			"{% url 'proccess_fn_costing_and_stock' %}",
			JSON.stringify(
				{
					if_save:true,
					date_range: {
						end_date:new Date($("#id_fecha_final").val()),
						start_date:new Date($("#id_fecha_nota_inicial").val())
					}
				}
			),
			llenar_planilla
		);
	});
	$("#form_costing_and_stock").submit(function(event) {
		event.preventDefault();
		$.post(
			"{% url 'proccess_fn_costing_and_stock' %}",
			JSON.stringify(
				{
					if_save:false,
					date_range: {
						end_date:new Date($("#id_fecha_final").val()),
						start_date:new Date($("#id_fecha_nota_inicial").val())
					}
				}
			),
			llenar_planilla
		);
	});
</script>
{% endblock content_script %}
