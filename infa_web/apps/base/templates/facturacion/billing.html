{% extends 'layouts/base.html' %}

{% load static %}

{% block content_head %}
	<link rel="stylesheet" href="{% static 'css/dataTables.bootstrap.css' %}">
	<link rel="stylesheet" href="https://cdn.rawgit.com/Eonasdan/bootstrap-datetimepicker/e8bddc60e73c1ec2475f827be36e1957af72e2ea/build/css/bootstrap-datetimepicker.css">
{% endblock content_head %}

{% block content %}
	{% include 'elements/nav.html' %}
	{% include 'elements/sidebar.html' %}
	<div class="content-wrapper" style="min-height: 921px;">
		<section class="content-header">
			<h1>Facturas</h1>
		</section>
		<section class="content">
			<form class="form-horizontal" id="form_movement">
				<input type="hidden" value="{{mode_view}}" name="mode_view" id="mode_view">

				<div class="row">
					<div class="col-md-12">
						<div class="box box-primary">
							<div class="box-header with-border">
								<h3 class="box-title">{{title}}</h3>
							</div>
							<div class="box-body">
								<div class="col-md-2 nopadding">
									<img src="{% static 'img/empresa.png' %}" alt="">
								</div>

								<div class="col-md-5 nopadding">

									<div class="form-group col-md-12">
										<label for="{{form.citerce.id_for_label}}" class="col-sm-2 control-label">{{form.citerce.label}}</label>
										{%if form.citerce.errors%}
										{{form.citerce.errors}}
										{%endif%}
										<div class="col-sm-10">
											<div class="input-group">
												<input type="number" value="{{form.citerce.field.widget.attrs.value}}" name="{{form.citerce.name}}" id="{{form.citerce.id_for_label}}" class="{{form.citerce.field.widget.attrs.class}}" {% if form.citerce.field.required %}required{% endif %}>
												<span class="input-group-addon"><a data-new-window href="{% url 'add-third-party' %}" target="_blank"><i class="fa fa-plus-square"></i></a></span>
												<span class="input-group-addon"><a data-new-window href="{% url 'list-third-parties' %}" target="_blank"><i class="fa fa-search"></i></a></span>
											</div>
										</div>
										<div class="col-sm-12">
											<input type="text" name="name__{{form.citerce.name}}" id="name__{{form.citerce.name}}" class="form-control" readonly>
										</div>
									</div>

									<div class="form-group col-md-12">
										<label for="{{form.cvende.id_for_label}}" class="col-sm-2 control-label">{{form.cvende.label}}</label>
										{%if form.cvende.errors%}
										{{form.cvende.errors}}
										{%endif%}
										<div class="col-sm-10">
											{{form.cvende}}
										</div>
									</div>

									<div class="form-group col-md-12">
										<label for="{{form.cdomici.id_for_label}}" class="col-sm-2 control-label">{{form.cdomici.label}}</label>
										{%if form.cdomici.errors%}
										{{form.cdomici.errors}}
										{%endif%}
										<div class="col-sm-10">
											{{form.cdomici}}
										</div>
									</div>

									<div class="form-group col-md-12">
										<label for="{{form.ctifopa.id_for_label}}" class="col-sm-2 control-label">{{form.ctifopa.label}}</label>
										{%if form.ctifopa.errors%}
										{{form.ctifopa.errors}}
										{%endif%}
										<div class="col-sm-10">
											{{form.ctifopa}}
										</div>
									</div>
								</div>

								<div class="col-md-5 nopadding">
									<div class="form-group col-md-12">
										<label for="{{form.femi.id_for_label}}" class="col-sm-2 control-label">{{form.femi.label}}</label>
										{%if form.femi.errors%}
										{{form.femi.errors}}
										{%endif%}
										<div class="col-sm-10">
											<input type="text" value="{{form.femi.field.widget.attrs.value}}" name="{{form.femi.name}}" id="{{form.femi.id_for_label}}" class="{{form.femi.field.widget.attrs.class}}" {% if form.femi.field.required %}required{% endif %}>
										</div>
									</div>
									<div class="form-group col-md-12">
										<label for="{{form.fpago.id_for_label}}" class="col-sm-2 control-label">{{form.fpago.label}}</label>
										{%if form.fpago.errors%}
										{{form.fpago.errors}}
										{%endif%}
										<div class="col-sm-10">
											<input type="text" value="{{form.fpago.field.widget.attrs.value}}" name="{{form.fpago.name}}" id="{{form.fpago.id_for_label}}" class="{{form.fpago.field.widget.attrs.class}}" {% if form.fpago.field.required %}required{% endif %}>
										</div>
									</div>

									<div class="form-group col-md-12">
										<label for="{{form.cemdor.id_for_label}}" class="col-sm-2 control-label">{{form.cemdor.label}}</label>
										{%if form.cemdor.errors%}
										{{form.cemdor.errors}}
										{%endif%}
										<div class="col-sm-10">
											{{form.cemdor}}
										</div>
									</div>

									<div class="form-group col-md-12">
										<label for="{{form.ccaja.id_for_label}}" class="col-sm-2 control-label">{{form.ccaja.label}}</label>
										{%if form.ccaja.errors%}
										{{form.ccaja.errors}}
										{%endif%}
										<div class="col-sm-10">
											{{form.ccaja}}
										</div>
									</div>
									<div class="form-group col-md-12">
										<label for="{{form.cesdo.id_for_label}}" class="col-sm-2 control-label">{{form.cesdo.label}}</label>
										{%if form.cesdo.errors%}
										{{form.cesdo.errors}}
										{%endif%}
										<div class="col-sm-10">
											{{form.cesdo}}
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</form>

			<form class="form-horizontal" id="form_deta_movement">

				<div class="row">
					<div class="col-md-12">
						<div class="box box-primary">
							<div class="box-header with-border">
								<h3 class="box-title">Detalle</h3>
							</div>
							<div class="box-body">

								<section class="col-md-12" id="form_temp_mvendeta">
								</section>

								<section role="form" id="item_mdeta">
									<table class="table table-striped dataTable no-footer" cellspacing="0" width="100%">
										<thead>
											<tr>
												<th width="3%">It</th>
												<th width="20%">Cod Articulo</th>
												<th width="20%">Articulo</th>
												<th width="10%">Cantidad</th>
												<th width="10%">Descuento</th>
												<th width="10%">IVA</th>
												<th width="10%">V unitario</th>
												<th width="10%"></th>
											</tr>
											<tr>
												<th width="3%">
													<input type="hidden" name="{{ form_movement_detail.itfac.name }}" id="{{ form_movement_detail.itfac.id_for_label}}" >
												</th>
												<th width="20%">
													<div class="input-group">
														<input type="number" name="{{form_movement_detail.carlos.name}}" id="{{form_movement_detail.carlos.id_for_label}}" class="{{form_movement_detail.carlos.field.widget.attrs.class}}" required>
														<span class="input-group-addon"><a data-new-window href="{% url 'list-articles' %}" target="_blank"><i class="fa fa-search"></i></a></span>
													</div>
												</th>
												<th width="20%">
													<input type="text" name="name__{{form_movement_detail.carlos.name}}" id="name__{{form_movement_detail.carlos.name}}" class="form-control" readonly>
												</th>
												<th width="10%">{{ form_movement_detail.canti }}</th>
												<th width="10%">{{ form_movement_detail.pordes }}</th>
												<th width="10%">{{ form_movement_detail.civa }}</th>
												<th width="10%">{{ form_movement_detail.vunita }}</th>
												<th width="10%"><button type="submit" class="btn btn-success" id="add_item_mdeta"><i class="fa fa-plus-square"></i></button></th>
											</tr>
										</thead>
										<tbody>
										</tbody>
									</table>
								</section>

								<section role="form" id="list_items_mdeta">
									<table class="table table-striped dataTable no-footer text-center" cellspacing="0" width="100%">
										<tbody>
										</tbody>
									</table>
								</section>

							</div>
						</div>
					</div>
				</div>
			</form>

			<form role="form" id="form_totales">
				<div class="row">
					<div class="col-md-4">
						<div class="box box-primary">
							<div class="box-header with-border">
								<h3 class="box-title">Totales</h3>
							</div>
							<div class="box-body">
								<div class="form-group">
									<label for="{{form.vtiva.id_for_label}}">{{form.vtiva.label}}</label>
									{{form.vtiva}}
								</div>
								<div class="form-group">
									<label for="" >IVA</label>
									<input type="number" value="" name="" id="" class="form-control">
								</div>
								<div class="form-group">
									<label for="{{form.vflete.id_for_label}}" class="">{{form.vflete.label}}</label>
									{{form.vflete}}
								</div>
								<div class="form-group">
									<label for="{{form.vdescu.id_for_label}}" class="">{{form.vdescu.label}}</label>
									{{form.vdescu}}
								</div>
								<div class="form-group">
									<label for="{{form.vtbase.id_for_label}}" class="">{{form.vtbase.label}}</label>
									{{form.vtbase}}
								</div>
								<div class="form-group">
									<label for="{{form.vttotal.id_for_label}}" class="">{{form.vttotal.label}}</label>
									{{form.vttotal}}
								</div>
							</div>
						</div>
					</div>
					<div class="col-md-3">
						<div class="box box-primary">
							<div class="box-header with-border">
								<h3 class="box-title">Retencion Fuente</h3>
							</div>
							<div class="box-body">
								<div class="form-group">
									<label for="{{form.brtefte.id_for_label}}">{{form.brtefte.label}}</label>
									{{form.brtefte}}
								</div>
								<div class="form-group">
									<label for="{{form.prtefte.id_for_label}}">{{form.prtefte.label}}</label>
									{{form.prtefte}}
								</div>
								<div class="form-group">
									<label for="{{form.vrtefte.id_for_label}}">{{form.vrtefte.label}}</label>
									{{form.vrtefte}}
								</div>
							</div>
						</div>
					</div>
					<div class="col-md-5">
						<div class="box box-primary">
							<div class="box-header with-border">
								<h3 class="box-title">Formas de Pago</h3>
							</div>
							<div class="box-body">
								<table class="table">
									<thead>
										<tr>
											<th>Forma Pago</th>
											<th>Valor</th>
											<th>Numero</th>
											<th>Banco</th>
										</tr>
									</thead>
									<tbody>
										<tr>
											<td>Efectvio</td>
											<td>{{form.vefe}}</td>
										</tr>
										<tr>
											<td>Tarjeta</td>
											<td>{{form.vtar}}</td>
											<td>{{form.doctar}}</td>
											<td>{{form.bancotar}}</td>
										</tr>
										<tr>
											<td>Cheque</td>
											<td>{{form.vchq}}</td>
											<td>{{form.docchq}}</td>
											<td>{{form.bancochq}}</td>
										</tr>
										<tr>
											<td>Otro</td>
											<td><input type="number"></td>
											<td><input type="number"></td>
											<td><select name="" id=""></select></td>
										</tr>
									</tbody>
								</table>

								<div class="row">
									<div class="form-group col-md-6">
										<label for="{{form.ventre.id_for_label}}">{{form.ventre.label}}</label>
										{{form.ventre}}
									</div>
									<div class="form-group col-md-6">
										<label for="{{form.vcambio.id_for_label}}">{{form.vcambio.label}}</label>
										{{form.vcambio}}
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</form>

			<div class="text-center">
				<div class="btn-group">
					<button class="btn btn-app btn-info" type="reset">
						<i class="fa fa-plus-square-o"></i>Nuevo
					</button>
					<button class="btn btn-app" type="submit" id="btn-save">
						<i class="fa fa-plus-square-o"></i>Guardar
					</button>
					{% if is_input_movement %}
						<a data-new-window class="btn btn-app" href="{% url 'list-input-movements' %}"><i class="fa fa-list"></i>Listar</a>
					{% else %}
						<a data-new-window class="btn btn-app" href="{% url 'list-output-movements' %}"><i class="fa fa-list"></i>Listar</a>
					{% endif %}
				</div>
			</div>

		</section>
	</div>
	{% include 'elements/footer.html' %}
{% endblock %}

{% block content_script %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.js"></script>
<script src="https://cdn.rawgit.com/Eonasdan/bootstrap-datetimepicker/e8bddc60e73c1ec2475f827be36e1957af72e2ea/src/js/bootstrap-datetimepicker.js"></script>

<script>
	var mode_view = $("#mode_view").val()
	var current_arlo = null
	var current_tercero = null

	/* Validaciones */
	$("[name=vttotal]").change(function(){
		if( parseFloat($(this).val()) > parseFloat(data_validation.top_sales_invoice) ){
			if(!confirm("La factura ha superado el Valor Total maximo de " + data_validation.top_sales_invoice + ", ¿Desea Continuar?")){
				$(this).val("")
			}

		}
		
	})
	$("#form_deta_movement [name=pordes]").change(function(){
		if( parseFloat($(this).val()) > parseFloat(data_validation.top_discount_bills) ){
			$(this).val("")
			alert("El Tope de Descuento es " + data_validation.top_discount_bills)
		}
		calcular_valor_unitario()
	})

	$("#form_deta_movement [name=vunita]").change(function(){
		min_precio_venta = 900
		if( parseFloat($(this).val()) < parseFloat(min_precio_venta) ){
			if(!confirm("El precio Unitario es menor al precio de Venta, ¿Desea Continuar?")){
				$(this).val("")
			}
		}
	})
	/* Validaciones */

	/* Totalizar */
	$(window).keydown(function(event) {
		if(event.altKey && event.keyCode == 84) {
			event.preventDefault(); 
			totalizar()
		}
	})
	/* Totalizar */


	function totalizar(){
		//if($("[name=ctifopa]").val() == ""){}else{}
		console.log("Totalizando")
	}

	function edit_item_mdeta(){
		var target = $(this)
		parent = target.closest("tr")
		parent.find("[data-name]").each(function(i,e){

			var td = $(e)

			var input = $("#item_mdeta").find("[name = " + td.data("name") + "]")
			input.val(td.data("value"))
		})
		parent.remove()
	}

	function delete_item_mdeta(){
		$(this).closest("tr").remove()
		calcular_total()
	}

	function calcular_valor_unitario(){
		name_list_price = "pvta" + current_tercero.clipre
		var price_venta = parseFloat(current_arlo[name_list_price])
		var descuento = parseFloat($("#form_deta_movement [name=pordes]").val())

		var vunita = price_venta - (price_venta*(descuento/100))
		$("#form_deta_movement [name=vunita]").val(vunita).trigger("change")
	}
	function calcular_total(){
		vtotal_temp = 0
		$("#list_items_mdeta").find("[data-name=vunita]").toArray().forEach(function(e){vtotal_temp += parseFloat($(e).data("value"));})
		$("[name=vttotal]").val(vtotal_temp)
		$("[data-mask=id_vttotal__mask]").val(currencyFormat.format(vtotal_temp))
	}

	function get_mdeta(){
		return 	$("#list_items_mdeta").find("tr").toArray().map(
			function(e){
				var data = {}
				$(e).children("[data-name]").toArray().forEach(
					function(e2){
						data[$(e2).data("name")] = $(e2).data("value")
					}
				)
				return data
			}
		)
	}

	function setValueFieldTerce(){
		if(current_tercero){
			id_citerce = current_tercero.idterce
			name__citerce = current_tercero.rasocial
		}else{
			id_citerce = ""
			name__citerce = ""
		}
		$('#id_citerce').val(id_citerce)
		$("[name=name__citerce]").val(name__citerce)
	}

	function setValueFieldArlo(){
		$("[name=name__carlos]").prop("readonly",true)
		if(current_arlo){
			//var vunita = current_arlo.vcosto
			var name__carlos = current_arlo.nlargo
			var ivas_civa = current_arlo.ivas_civa

			if(current_arlo.ifedinom) $("[name=name__carlos]").prop("readonly",false)

		}else{
			//var vunita = ""
			var name__carlos = ""
			var ivas_civa = ""
		}
		//$("[name='vunita']")
			//.val(vunita)
			//.trigger("change")
		$("[name=name__carlos]").val(name__carlos)
		$("[name=civa]").val(ivas_civa)

		calcular_valor_unitario()
	}

	function showPrecioVenta(fields){
		var table = $("<table>")
			for (field in fields){
				regexp = /pvta[0-9]/
				if(regexp.test(field)){
					table.append(
						$("<tr>").append(
							$("<td>",{html:field.replace("pvta", 'Precio Venta ')}),
							$("<td>",{html:currencyFormat.format(fields[field])})
						)
					)
					console.log(field)
				}
			}
	}

	$('#id_carlos').change(function(){
		var input_value = this.value
		if(!input_value){
			setValueFieldArlo("","","")
			return
		}
		$.post('{% url 'api-get-object' %}',JSON.stringify({'model': 5,'field': this.name,'value': input_value}),function(response){
			if(response.object){
				var object = JSON.parse(response.object)[0]
				fields = object.fields
				current_arlo = fields
				
				//var t_vcosto = fields.vcosto
				//var t_iva = fields.ivas_civa
				//var t_nlargo = fields.nlargo

				showPrecioVenta(fields)
				//setValueFieldArlo(t_vcosto,t_nlargo,t_iva)
				setValueFieldArlo()
			}else{
				current_arlo = null
				$.post('{% url 'api-get-object' %}',JSON.stringify({'model': 5,'field': "cbarras",'value': input_value}),function(response){
					if(response.object){
						var object = JSON.parse(response.object)[0]
						fields = object.fields
						current_arlo = fields

						//var t_vcosto = fields.vcosto
						//var t_nlargo = fields.nlargo
						//var t_iva = fields.ivas_civa

					}else{
						//var t_vcosto = ""
						//var t_nlargo = ""
						//var t_iva = ""
						$('#id_carlos').val("")
						tooltipBootstrap($('#id_carlos'),".input-group","Este Articulo no se encuentra registrado.")

						current_arlo = null
					}
					showPrecioVenta(fields)
					//setValueFieldArlo(t_vcosto,t_nlargo,t_iva)
					setValueFieldArlo()
				})
			}
		})
	});

	$('#id_citerce').change(function(){
		var input_value = this.value
		current_tercero = null

		if(!input_value){
			setValueFieldTerce()
			return
		}
		$.post('{% url 'api-get-object' %}',JSON.stringify({'model': 29,'field': this.name,'value': this.value}),function(response){
			if(response.object){
				var object = JSON.parse(response.object)[0]
				fields = object.fields
				current_tercero = fields
				//t_rasocial = fields.rasocial
			}else{
				current_tercero = null
				tooltipBootstrap($('#id_citerce'),".form-group","Esta Idendificación no se encuentra registrada.")
				//t_rasocial = ""
				//$('#id_citerce').val("")
			}
				//$("[name=name__citerce]").val(t_rasocial)
			setValueFieldTerce()
		})
	});

	$("#form_deta_movement").submit(function(event){
		event.preventDefault()
		if(customValidationInput("#item_mdeta").valid){
			var tr = $("<tr>")
			$('#item_mdeta')
			.find("input,select")
			.toArray()
			.forEach(function(e,i){
				var oth = $(e).closest("th")

				var value = e.value
				var data_value = e.value

				if(eval($(e).data("if-currency"))){
					var value = currencyFormat.format(e.value)
				}

				tr.append($("<td>",{
					width:oth.attr("width"),
					"data-name":e.name,
					"data-value":data_value,
					html:value}))
			})
			td = $("<td width='10%'>")
			var btnEdit = td.append($("<span class='btn btn-info' ><i class='fa fa-edit '></span>").click(edit_item_mdeta))
			var btnDelete = td.append($("<span class='btn btn-danger' ><i class='fa fa-remove'></span>").click(delete_item_mdeta))
			tr.append(btnEdit,btnDelete)
			$("#list_items_mdeta").find("tbody").append(tr)
			
			$('#item_mdeta').find("input,select").val("")
			$('#item_mdeta').find("[name=canti]").val(1)
			var it = 1
			$("#list_items_mdeta").find("[data-name=it]").toArray().forEach(
				function(e){
					$(e).html(it);
					$(e).attr("data-value",it);
					it++
				})
			calcular_total()
		}
	})

	$("#btn-save").click(function(event){
		event.preventDefault()

		if(!customValidationInput("#form_movement").valid) return
		if(!customValidationInput("#form_totales").valid) return

		var currentForm = $("#form_movement")

		var querystring = $("form:not(#form_deta_movement)").serialize();
		var data = JSON.parse('{"' + decodeURI(querystring).replace(/"/g, '\\"').replace(/&/g, '","').replace(/=/g,'":"') + '"}')

		var array_mvdeta = get_mdeta()

		if(array_mvdeta.length){
			data.mvdeta = array_mvdeta
		}else{
			var message = alertBootstrap("No ha ingresado Ningun Articulo","warning")
			currentForm.prepend(message)
			return
		}
		console.warn(data)
		loading_animation("Guardando Movimiento.")
		$.ajax({
			//url: '{% url 'save-movement' %}',
			url: '{{url}}',
			type: 'POST',
			data: JSON.stringify(data),
			contentType: "application/json",
			error: function(response){
				var message = alertBootstrap("Ha ocurrido un error en el proceso.","danger")
				currentForm.prepend(message)
				$(".animation").empty()
			},
			success: function(response){
				if(response.error){
					var message = alertBootstrap(response.message,"danger")
				}else{
					if(mode_view != "edit"){
						$("[name*=cmv]").val(response.cmv)
					}
					var message = alertBootstrap(response.message,"success")
				}
				if(mode_view != "edit"){
					$("#list_items_mdeta").find("tbody").children().remove()
				}
				currentForm.prepend(message)
				$(".animation").empty()
			}
		});
	})


	var data_validation = {{data_validation_json|safe}}

	{% if mvdeta_json %}
		var js_list = {{mvdeta_json|safe}}
	{% else %}
		var js_list = []
	{% endif %}
	js_list.forEach(function(object){
		$('#item_mdeta').find("#id_carlos").val(object.fields.carlos)
		$('#item_mdeta').find("#name__carlos").val(object.fields.nlargo)
		$('#item_mdeta').find("#id_canti").val(object.fields.canti)
		$('#item_mdeta').find("#id_vunita").val(object.fields.vunita)
		$('#item_mdeta').find("#id_vtotal").val(object.fields.vtotal)
		$('#form_deta_movement').submit()
		$('#form_deta_movement').trigger("reset")
		calcular_total()
	})

	$('.date').datetimepicker({
		format: 'YYYY-MM-D',
		defaultDate:date_appen
	});
	
	$('#id_citerce').change()

</script>
{% endblock content_script %}
